# Render 設定手順書

## 📋 Render Cron Job セットアップガイド

このドキュメントでは、Render で Discord-Slack 通知システムの Cron Job を設定する手順を説明します。

---

## 🚀 ステップ1: Render アカウントの準備

### 1.1 Render にログイン

1. https://render.com にアクセス
2. GitHubアカウントでサインアップ/ログイン（推奨）
3. ダッシュボードが表示されることを確認

---

## 🔗 ステップ2: GitHub リポジトリを接続

### 2.1 新しい Cron Job を作成

1. Render ダッシュボード右上の **「New +」** ボタンをクリック
2. ドロップダウンから **「Cron Job」** を選択

### 2.2 リポジトリを接続

1. **「Connect a repository」** をクリック
2. GitHub アカウントを認証（初回のみ）
3. リポジトリ一覧から **`payment-notification-system`** を検索
4. **「Connect」** をクリック

---

## ⚙️ ステップ3: Cron Job の基本設定

以下の情報を入力してください：

### 3.1 基本情報

| 項目 | 値 | 説明 |
|------|-----|------|
| **Name** | `discord-payment-notifier` | Cron Jobの識別名 |
| **Environment** | `Node` | 実行環境 |
| **Region** | `Oregon (US West)` | 最寄りのリージョンを選択 |
| **Branch** | `main` | デプロイするブランチ |

### 3.2 ビルド設定

| 項目 | 値 |
|------|-----|
| **Build Command** | （空欄でOK） |
| **Start Command** | `node src/discord-slack-notifier.js` |

### 3.3 スケジュール設定

| 項目 | 値 | 説明 |
|------|-----|------|
| **Schedule** | `0 */3 * * *` | 3時間ごとに実行 |

**Cron式の説明:**
```
0 */3 * * *
│  │  │ │ │
│  │  │ │ └─ 曜日 (0-6, 0=日曜)
│  │  │ └─── 月 (1-12)
│  │  └───── 日 (1-31)
│  └──────── 時 (0-23, */3 = 3時間ごと)
└─────────── 分 (0-59)
```

**その他のスケジュール例:**
- `0 */1 * * *` - 1時間ごと
- `0 */6 * * *` - 6時間ごと
- `0 0 * * *` - 毎日 0:00
- `0 9,15,21 * * *` - 毎日 9:00, 15:00, 21:00

---

## 🔐 ステップ4: 環境変数の設定

### 4.1 環境変数を追加

**「Environment Variables」** セクションで、以下の3つの環境変数を追加してください：

#### 変数1: DISCORD_BOT_TOKEN

| 項目 | 値 |
|------|-----|
| **Key** | `DISCORD_BOT_TOKEN` |
| **Value** | `あなたのDiscord Bot Token` |

**取得方法:**
1. Discord Developer Portal (https://discord.com/developers/applications) にアクセス
2. アプリケーションを選択 → Bot → Token をコピー

#### 変数2: SLACK_WEBHOOK_URL

| 項目 | 値 |
|------|-----|
| **Key** | `SLACK_WEBHOOK_URL` |
| **Value** | `あなたのSlack Webhook URL` |

**取得方法:**
1. Slack API (https://api.slack.com/apps) にアクセス
2. アプリを選択 → Incoming Webhooks → Webhook URL をコピー

#### 変数3: DISCORD_GUILD_IDS（オプション）

| 項目 | 値 |
|------|-----|
| **Key** | `DISCORD_GUILD_IDS` |
| **Value** | `1224342407425032304,1224343682040201297,1224344095053316146,...` （全29サーバーID） |

**注意:** 
- `DISCORD_GUILD_IDS` を設定しない場合、`config.json` から読み込まれます
- サーバーIDはカンマ区切りで入力（スペースなし）

### 4.2 全サーバーIDのリスト

```
1224342407425032304,1224343682040201297,1224344095053316146,1224776476172488705,1224356916935790654,1242041716593131580,1243422872840573013,1262456039912243355,1267703881086013481,1274043241632763915,1277984386041511979,1286461662601150525,1291308937706078258,1310474190935167038,1321761988711419964,1331642026764271677,1339080758790328461,1348494125699170314,1357344774960578741,1366987031003009104,1383691215056273438,1391627571497537706,1400114363951747092,1407256533569503272,1415917261855658004,1423571581493448737,1433824556660822028,1443256326565400740,1446118928756641866
```

---

## ✅ ステップ5: Cron Job を作成

1. すべての設定を確認
2. 画面下部の **「Create Cron Job」** ボタンをクリック
3. デプロイが開始されます（初回は数分かかります）

---

## 🧪 ステップ6: 動作確認

### 6.1 手動でテスト実行

1. Render ダッシュボードで作成した Cron Job を開く
2. 右上の **「Trigger Run」** ボタンをクリック
3. **「Logs」** タブで実行ログを確認

### 6.2 ログの確認

以下のような出力が確認できれば成功です：

```
============================================================
メンションなし支払い連絡通知システム - 実行開始
実行時刻: 2026/1/2 12:00:00
============================================================

📊 設定情報:
  - 監視サーバー数: 29
  - 監視キーワード数: 9
  - 監視期間: 過去 3 時間
  - 並列処理: 有効 (チャンネルごとに5並列)

[1/29] サーバー 1224342407425032304 (WannaV1) を処理中...
  ✓ テキストチャンネル数: 444
  処理中: 5/444 チャンネル
  ...
```

### 6.3 Slack で確認

実行完了後、Slack に以下の通知が届くことを確認：

- ✅ 実行サマリー（毎回）
- ✅ キーワード検出通知（該当メッセージがある場合）

---

## 🔧 ステップ7: 運用設定

### 7.1 通知設定

Render では実行失敗時に通知を受け取ることができます：

1. Cron Job の **「Settings」** タブを開く
2. **「Notifications」** セクションで通知先を設定
   - Email
   - Slack
   - Discord

### 7.2 タイムゾーン設定

デフォルトは UTC です。日本時間で実行したい場合：

**環境変数を追加:**
```
TZ=Asia/Tokyo
```

**スケジュールを調整:**
- 日本時間 9:00 → `0 0 * * *` (UTC 0:00 = JST 9:00)
- 日本時間 12:00 → `0 3 * * *` (UTC 3:00 = JST 12:00)

---

## 📊 ステップ8: 監視とメンテナンス

### 8.1 実行履歴の確認

1. Render ダッシュボードで Cron Job を開く
2. **「Jobs」** タブで過去の実行履歴を確認
3. 各実行をクリックして詳細ログを表示

### 8.2 サーバーの追加方法

新しいDiscordサーバーを追加する場合：

**方法1: 環境変数を更新（推奨）**
1. Render ダッシュボード → **「Environment」** タブ
2. `DISCORD_GUILD_IDS` を編集
3. 新しいサーバーIDを追加（カンマ区切り）
4. **「Save Changes」** をクリック（自動で再デプロイ）

**方法2: config.json を更新**
1. GitHub で `config.json` を編集
2. `guildIds` 配列に新しいサーバーIDを追加
3. コミット＆プッシュ
4. Render が自動で再デプロイ

### 8.3 エラー発生時の対応

**ログを確認:**
```
❌ エラー: DISCORD_BOT_TOKEN が設定されていません
→ 環境変数を確認

❌ Discord API Error: 401
→ Bot Token が無効または期限切れ

❌ Slack API Error: 404
→ Webhook URL が無効
```

---

## 💰 料金について

### 無料プラン

- **Cron Job**: 無料
- **実行時間**: 月間400時間まで無料
- **メモリ**: 512MB

**推定コスト:**
- 3時間ごとの実行: 1日8回 × 10分 = 80分/日
- 月間: 80分 × 30日 = 2,400分 (40時間)
- **結論**: 無料プランで十分

### 有料プラン（必要な場合）

- **Starter**: $7/月 - 実行時間無制限
- **Standard**: $25/月 - 優先実行、高速CPU

---

## 🎯 完了チェックリスト

セットアップが完了したら、以下を確認してください：

- [ ] Render Cron Job が作成されている
- [ ] 環境変数が3つ設定されている
- [ ] スケジュール `0 */3 * * *` が設定されている
- [ ] 手動実行でテストが成功
- [ ] Slack に実行サマリーが届いている
- [ ] ログで全29サーバーが処理されている
- [ ] エラーがない、または許容範囲内

---

## 🆘 トラブルシューティング

### Q1: デプロイが失敗する

**A:** ログを確認して、以下を試してください：
- Build Command は空欄にする
- Start Command が `node src/discord-slack-notifier.js` になっているか確認
- Branch が `main` になっているか確認

### Q2: 実行はされるが通知が来ない

**A:** 以下を確認：
- 環境変数が正しく設定されているか
- Discord Bot Token が有効か
- Slack Webhook URL が正しいか
- 過去3時間以内にキーワードを含むメッセージがあるか

### Q3: 実行時間が長すぎる

**A:** 正常です：
- 29サーバー × 約400チャンネル = 約12,000チャンネル
- 並列処理でも5-10分かかります
- Render の無料プランで問題なく動作します

---

## 📞 サポート

問題が解決しない場合：

1. Render のログを確認
2. GitHub Issues で報告
3. README.md のトラブルシューティングを参照

---

**これでセットアップは完了です！🎉**

3時間ごとに自動で Discord メッセージを監視し、支払い関連のキーワードを検出して Slack に通知します。
