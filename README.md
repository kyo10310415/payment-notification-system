# メンションなし支払い連絡通知システム

Discord の複数サーバーを監視し、支払い関連のキーワードが含まれたメッセージを自動検出して Slack に通知するシステムです。

## 📋 概要

- **監視対象**: 29の Discord サーバー（合計約12,000チャンネル以上）
- **実行頻度**: 3時間ごと（Render Cron Jobs で自動実行）
- **監視期間**: 実行時刻から過去3時間以内のメッセージ
- **検出キーワード**: 支払い、支払、振込、振り込み、振込み、入金、引き落とし、引き落し、引落
- **通知先**: Slack（Webhook経由）

## ✨ 特徴

- ✅ **高速並列処理**: サーバーとチャンネルを並列処理し、実行時間を大幅短縮
- ✅ **実行時間の可視化**: 各サーバーの処理時間と全体の実行時間をログとSlackで確認可能
- ✅ **柔軟な設定管理**: 環境変数またはconfig.jsonで設定可能
- ✅ **エラーハンドリング**: 一部のチャンネルでエラーが発生しても処理を継続
- ✅ **詳細なログ**: 処理状況と結果を詳細に出力
- ✅ **リアクション監視**: 検出したメッセージへのリアクションを72時間追跡
- ✅ **返信監視**: 検出したメッセージへの返信を72時間追跡
- ✅ **Slackスレッド通知**: リアクションと返信を元のSlack通知のスレッドに自動送信

## 🏗️ システム構成

```
GitHub Repository
├── src/
│   └── discord-slack-notifier.js  # メインスクリプト
├── config.json                     # サーバーID・キーワード設定
├── package.json
├── .env.example                    # 環境変数のサンプル
└── README.md

↓ GitHub連携

Render Cron Job
├── スケジュール: 0 */3 * * * (3時間ごと)
├── コマンド: node src/discord-slack-notifier.js
└── 環境変数:
    ├── DISCORD_BOT_TOKEN
    ├── SLACK_WEBHOOK_URL
    └── DISCORD_GUILD_IDS (オプション)
```

## 🚀 セットアップ手順

### 1. リポジトリをクローン

```bash
git clone https://github.com/YOUR_USERNAME/payment-notification-system.git
cd payment-notification-system
```

### 2. Render で Cron Job を作成

1. **Render にログイン**
   - https://render.com にアクセス

2. **新しい Cron Job を作成**
   - ダッシュボードから「New +」→「Cron Job」を選択

3. **リポジトリを接続**
   - GitHub リポジトリを選択: `payment-notification-system`

4. **基本設定**
   - **Name**: `discord-payment-notifier`
   - **Environment**: `Node`
   - **Command**: `node src/discord-slack-notifier.js`
   - **Schedule**: `0 */3 * * *` (3時間ごと)

5. **環境変数を設定**
   
   以下の環境変数を追加:
   
   | キー | 値 | 説明 |
   |------|-----|------|
   | `DISCORD_BOT_TOKEN` | `MTQ1NT...` | Discord Bot Token |
   | `SLACK_WEBHOOK_URL` | `https://hooks.slack.com/...` | Slack Webhook URL |
   | `DISCORD_GUILD_IDS` | `1224342407425032304,1224343682040201297,...` | （オプション）監視するサーバーID |

   **注意**: `DISCORD_GUILD_IDS` を設定しない場合、`config.json` から読み込まれます。

6. **Create Cron Job** をクリック

### 3. 手動でテスト実行

Render のダッシュボードから「Trigger Run」をクリックして、すぐに実行をテストできます。

## 📝 設定ファイル

### config.json

サーバーIDとキーワードを管理します。

```json
{
  "guildIds": [
    "1224342407425032304",
    "1224343682040201297",
    ...
  ],
  "keywords": [
    "支払い",
    "支払",
    "振込",
    "振り込み",
    "振込み",
    "入金",
    "引き落とし",
    "引き落し",
    "引落"
  ],
  "excludeKeywords": [
    "サービスサイト"
  ],
  "excludeUserIds": [
    "1371842840258285628",
    "1423132417744441445"
  ],
  "excludeUsernames": [
    "Captain Hook"
  ],
  "checkIntervalHours": 3
}
```

### 設定項目の説明

- **guildIds**: 監視対象のDiscordサーバーID一覧
- **keywords**: 検出対象のキーワード一覧
- **excludeKeywords**: 除外するキーワード（例: 「サービスサイト」を含むメッセージは通知しない）
- **excludeUserIds**: 除外するユーザーIDリスト（特定のBotやユーザーを無視）
- **excludeUsernames**: 除外するユーザー名リスト（Webhook名など）
- **checkIntervalHours**: 監視期間（時間単位、デフォルト: 3）

## 🔧 サーバーの追加方法

新しいDiscordサーバーを監視対象に追加する場合、以下の3つの方法があります:

### 方法1: Render の環境変数を更新（推奨）

1. Render ダッシュボードで Cron Job を開く
2. 「Environment」タブを選択
3. `DISCORD_GUILD_IDS` にサーバーIDを追加（カンマ区切り）
4. 「Save Changes」をクリック

**所要時間**: 約1分（再デプロイ不要）

### 方法2: config.json を更新

1. `config.json` を編集
2. `guildIds` 配列に新しいサーバーIDを追加
3. GitHub にコミット＆プッシュ
4. Render が自動で再デプロイ

**所要時間**: 約3-5分（自動デプロイ）

### 方法3: ローカルで実行

```bash
# 環境変数を設定
export DISCORD_BOT_TOKEN="your-token"
export SLACK_WEBHOOK_URL="your-webhook-url"

# 実行
node src/discord-slack-notifier.js
```

## 📊 実行結果の確認

### コンソールログ

実行中は以下の情報がコンソールに出力されます:

```
============================================================
メンションなし支払い連絡通知システム - 実行開始
実行時刻: 2026/1/2 9:25:51
============================================================

📊 設定情報:
  - 監視サーバー数: 29
  - 監視キーワード数: 9
  - 監視期間: 過去 3 時間
  - 並列処理: 有効 (チャンネルごとに5並列)

[1/29] サーバー 1224342407425032304 (WannaV1) を処理中...
  ✓ テキストチャンネル数: 444
  処理中: 5/444 チャンネル
  ...
  ✓ 完了 (45.23秒)

============================================================
📊 実行結果サマリー
============================================================
実行時間: 320.45秒
監視サーバー数: 29
監視チャンネル数: 12,756
確認メッセージ数: 45,320
キーワード検出数: 3
エラー数: 0
```

### Slack 通知

#### キーワード検出時

支払い関連のキーワードが検出されると、Slackに以下の情報が送信されます:

- **@channel メンション**: チャンネル全体に通知
- サーバー名
- チャンネル名
- 送信者
- 送信時刻
- メッセージ全文
- メッセージへの直接リンク

#### リアクション・返信の監視

検出されたメッセージは72時間追跡され、以下の反応があった場合、**元のSlack通知のスレッドに自動通知**されます:

**リアクションの例:**
```
👍 田中太郎さんが ❤️ でリアクションしました
```

**返信の例:**
```
💬 返信: 鈴木花子
「了解しました。本日中に対応します。」
```

**Slack通知の構造:**
```
💰 支払い関連メッセージが検出されました  ← 元のメッセージ
├─ 👍 田中太郎さんが ❤️ でリアクションしました
├─ 💬 返信: 鈴木花子
│   「了解しました。本日中に対応します。」
└─ 💬 返信: 佐藤次郎
    「確認しました。ありがとうございます。」
```

#### 実行完了時

毎回実行が完了すると、サマリーが Slack に送信されます:

- 実行時間
- 監視サーバー数
- 監視チャンネル数
- 確認メッセージ数
- キーワード検出数
- エラー数

## 🎯 パフォーマンス

### 並列処理の効果

- **サーバー並列**: 3サーバー同時処理
- **チャンネル並列**: 各サーバーで5チャンネル同時処理
- **推定実行時間**: 約5-10分（29サーバー、12,000チャンネル）

### レート制限対策

- Discord API のレート制限を考慮し、適切な待機時間を設定
- バッチ処理ごとに200ms待機

## 🛠️ トラブルシューティング

### エラー: DISCORD_BOT_TOKEN が設定されていません

環境変数 `DISCORD_BOT_TOKEN` が設定されていることを確認してください。

### エラー: Discord API Error: 401

Discord Bot Token が無効または期限切れです。新しいトークンを取得してください。

### エラー: Slack API Error: 404

Slack Webhook URL が無効です。正しいURLを設定してください。

### 実行時間が長すぎる

- サーバー数またはチャンネル数が多い場合、実行に時間がかかります
- Render の無料プランでは実行時間に制限があるため、有料プランを検討してください

## 📦 依存関係

このプロジェクトは Node.js の標準ライブラリのみを使用しており、外部パッケージは不要です。

- Node.js: >= 14.0.0
- 必要なモジュール: `https`, `fs`, `path`（すべて標準ライブラリ）

## 📊 データ管理

### 追跡メッセージデータ (tracked-messages.json)

検出されたメッセージの情報は、`tracked-messages.json` に保存されます:

```json
{
  "messages": [
    {
      "discordMessageId": "1234567890123456789",
      "discordChannelId": "9876543210987654321",
      "discordGuildId": "1224342407425032304",
      "slackThreadTs": "1704211200.123456",
      "detectedAt": "2026-01-02T12:00:00Z",
      "lastCheckedAt": "2026-01-02T15:00:00Z",
      "notifiedReactions": ["123456-❤️", "789012-👍"],
      "notifiedReplies": ["reply-id-1", "reply-id-2"]
    }
  ]
}
```

### データのライフサイクル

1. **メッセージ検出**: キーワードを含むメッセージが検出されると、追跡データに追加
2. **定期チェック**: 3時間ごとに追跡中のメッセージのリアクション・返信をチェック
3. **自動削除**: 72時間経過したメッセージは自動的に削除され、追跡を終了

### 注意事項

- `tracked-messages.json` は実行時に自動生成されます
- このファイルは `.gitignore` に含まれており、Gitには含まれません
- Render の一時ストレージに保存されるため、デプロイ時にリセットされます

## 📄 ライセンス

MIT License

## 🤝 サポート

問題が発生した場合は、GitHub Issues で報告してください。
